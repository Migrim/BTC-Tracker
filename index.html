<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live BTC Price</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Bricolage Grotesque', sans-serif;
            background-color: #f5f5f5;
            background-image: 
                linear-gradient(to right, rgba(200, 200, 200, 0.2) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(200, 200, 200, 0.2) 1px, transparent 1px);
            background-size: 70px 70px; 
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .card {
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            width: 300px;
            position: relative;
        }
        #btc-chart {
            width: 100%;
            height: 100px; 
        }
        .card h1 {
            margin: 0;
            font-size: 2rem;
            color: #333;
        }

        .card p {
            margin: 10px 0;
            font-size: 1.5rem;
            color: #666;
            display: flex; 
            justify-content: center;
            perspective: 1000px; 
            font-family: 'Roboto', sans-serif;
        }
        #price span:last-child {
            margin-left: 0px; 
        }
        .char {
            display: inline-block;
            transform-style: preserve-3d;
            animation: flip 0.6s ease-in-out;
            animation-fill-mode: forwards; 
        }

        @keyframes flip {
            0% {
                transform: rotateX(0deg);
            }
            50% {
                transform: rotateX(90deg);
                opacity: 0.5;
            }
            100% {
                transform: rotateX(0deg);
                opacity: 1;
            }
        }
        .fade {
            opacity: 0;
            animation: fadeIn 0s ease-in-out forwards;
        }

        @keyframes fadeIn {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }

        .percentage-box {
            font-family: 'Roboto', sans-serif;
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 3px 8px; 
            border-radius: 8px;
            font-size: 0.8rem; 
            font-weight: bold;
            color: #fff;
            background-color: #bbb; 
        }

        .percentage-box.up {
            background-color: #4caf50;
        }

        .percentage-box.down {
            background-color: #f44336;
        }
        .explanation-text {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 0.9rem;
            color: #555;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>BTC Price</h1>
        <p id="price">
            <span id="price-number">0,00</span><span>€</span>
        </p>        
        <div class="percentage-box" id="percentage-box">0%</div>
        <canvas id="btc-chart" width="300" height="150"></canvas>
    </div>    
    <div class="explanation-text">
        Price updates every 2 seconds and is live.<br>
        The graph and percentage reflect the movement of the last week.
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let lastPrice = 0;
        let lastWeekPrice = 0;
        let isInitialLoad = true; 
        let btcChart;

        async function fetchBTCPrice() {
            try {
                const response = await fetch('https://api.coindesk.com/v1/bpi/currentprice/EUR.json');
                const data = await response.json();
                return parseFloat(data.bpi.EUR.rate.replace(',', ''));
            } catch (error) {
                console.error("Error fetching BTC price:", error);
                return lastPrice;
            }
        }

        async function fetchBTCPriceLastWeek() {
            try {
                const response = await fetch('https://api.coindesk.com/v1/bpi/historical/close.json?currency=EUR');
                const data = await response.json();
                return data.bpi;
            } catch (error) {
                console.error("Error fetching last week's BTC price:", error);
                return {};
            }
        }

        function formatPrice(price) {
            return price.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        async function renderChart() {
            const btcData = await fetchBTCPriceLastWeek();
            const labels = Object.keys(btcData); 
            const data = Object.values(btcData); 

            const ctx = document.getElementById('btc-chart').getContext('2d');
            btcChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: 'rgba(247, 147, 26, 1)', 
                        backgroundColor: 'rgba(247, 147, 26, 0.2)', 
                        borderWidth: 2,
                        tension: 0.3, 
                        fill: true, 
                        pointRadius: 0, 
                        pointHoverRadius: 2 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    let value = context.raw;
                                    return `€${value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false, 
                            grid: { display: false } 
                        },
                        y: {
                            display: false, 
                            grid: { display: false } 
                        }
                    },
                    hover: {
                        mode: 'nearest', 
                        intersect: true
                    }
                }
            });

            const card = document.querySelector('.card');
            card.addEventListener('mouseenter', () => {
                btcChart.data.datasets[0].pointRadius = 2;
                btcChart.update();
            });
            card.addEventListener('mouseleave', () => {
                btcChart.data.datasets[0].pointRadius = 0; 
                btcChart.update();
            });
        }

        function animateTextUpdate(element, newText) {
            if (isInitialLoad) {
                element.textContent = newText;
                return;
            }

            const oldText = element.textContent;
            if (oldText === newText) return;

            element.innerHTML = '';
            const chars = newText.split('');
            chars.forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char;
                span.className = 'char';
                span.style.animationDelay = `${index * 0.1}s`; 
                element.appendChild(span);
            });
        }
        async function updatePrice() {
            const priceNumberElement = document.getElementById('price-number');

            const newPrice = await fetchBTCPrice();
            if (newPrice !== lastPrice) {
                if (!isInitialLoad) {
                    animateTextUpdate(priceNumberElement, formatPrice(newPrice));
                } else {
                    priceNumberElement.textContent = formatPrice(newPrice);
                }
            }

            lastPrice = newPrice;
        }

        async function updatePercentage() {
            const percentageBoxElement = document.getElementById('percentage-box');

            if (lastWeekPrice === 0) {
                percentageBoxElement.textContent = '▲▼ Calc'; 
                const btcData = await fetchBTCPriceLastWeek();
                lastWeekPrice = Object.values(btcData)[0];
                return;
            }

            if (lastPrice) {
                const percentageChange = (((lastPrice - lastWeekPrice) / lastWeekPrice) * 100).toFixed(2);
                const percentageText =
                    percentageChange > 0
                        ? `▲ +${percentageChange}%`
                        : percentageChange < 0
                        ? `▼ ${percentageChange}%`
                        : '0%';

                fadeTextUpdate(percentageBoxElement, percentageText);
                percentageBoxElement.className =
                    percentageChange > 0
                        ? 'percentage-box up'
                        : percentageChange < 0
                        ? 'percentage-box down'
                        : 'percentage-box';
            }
        }
        function fadeTextUpdate(element, newText) {
            const oldText = element.textContent;
            if (oldText === newText) return;

            element.classList.remove('fade');
            setTimeout(() => {
                element.textContent = newText;
                element.classList.add('fade');
            }, 50); 
        }

        setInterval(updatePrice, 2000); 
        setInterval(updatePercentage, 5000); 

        updatePrice().then(() => {
            isInitialLoad = false; 
        });
        updatePercentage();
        renderChart();
    </script>
</body>
</html>
